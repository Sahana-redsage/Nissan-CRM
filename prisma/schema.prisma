generator client {
  provider = "prisma-client-js"
}
 
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
 
model Telecaller {
  id               Int               @id @default(autoincrement())
  username         String            @unique
  email            String            @unique
  passwordHash     String            @map("password_hash")
  fullName         String            @map("full_name")
  phone            String?
  isActive         Boolean           @default(true) @map("is_active")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  callLogs         CallLog[]
  serviceDocuments ServiceDocument[]
  serviceInsights  ServiceInsight[]
  whatsappMessages WhatsappMessage[]
  smsMessages      SmsMessage[]
  serviceEmails    ServiceEmail[]
  @@map("telecallers")
}
 
model Customer {
  id                 Int               @id @default(autoincrement())
  customerName       String            @map("customer_name")
  email              String?
  phone              String
  alternatePhone     String?           @map("alternate_phone")
  address            String?
  city               String?
  state              String?
  pincode            String?
  vehicleNumber      String            @unique @map("vehicle_number")
  vehicleMake        String            @map("vehicle_make")
  vehicleModel       String            @map("vehicle_model")
  vehicleYear        Int?              @map("vehicle_year")
  purchaseDate       DateTime?         @map("purchase_date") @db.Date
  lastServiceDate    DateTime?         @map("last_service_date") @db.Date
  nextServiceDueDate DateTime          @map("next_service_due_date") @db.Date
  totalMileage       Int               @default(0) @map("total_mileage")
  prefServiceCenter  Int?              @map("pref_service_center")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")
  callLogs           CallLog[]
  serviceDocuments   ServiceDocument[]
  serviceInsights    ServiceInsight[]
  surveyResponses    SurveyResponse[]
  whatsappMessages   WhatsappMessage[]
  smsMessages        SmsMessage[]
  serviceEmails      ServiceEmail[]
  sourceMetrics      SourceMetric[]
  appointments       ServiceAppointment[]
  callbackRequests   CallbackRequest[]
  preferredServiceCenter ServiceCenter? @relation("PreferredServiceCenter", fields: [prefServiceCenter], references: [id])
  @@index([nextServiceDueDate])
  @@index([vehicleNumber])
  @@map("customers")
}
 
model ServiceDocument {
  id           Int        @id @default(autoincrement())
  customerId   Int        @map("customer_id")
  uploadedBy   Int        @map("uploaded_by")
  documentName String     @map("document_name")
  documentPath String     @map("document_path")
  documentType String     @default("service_history") @map("document_type")
  fileSize     Int?       @map("file_size")
  uploadedAt   DateTime   @default(now()) @map("uploaded_at")
  customer     Customer   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  telecaller   Telecaller @relation(fields: [uploadedBy], references: [id])
 
  @@index([customerId])
  @@map("service_documents")
}
 
model ServiceInsight {
  id             Int        @id @default(autoincrement())
  customerId     Int        @map("customer_id")
  generatedBy    Int        @map("generated_by")
  insightsJson   Json       @map("insights_json")
  rawLlmResponse String?    @map("raw_llm_response")
  documentIds    Int[]      @map("document_ids")
  generatedAt    DateTime   @default(now()) @map("generated_at")
  customer       Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  telecaller     Telecaller        @relation(fields: [generatedBy], references: [id])
  whatsappMessages WhatsappMessage[]
  smsMessages      SmsMessage[]
  serviceEmails    ServiceEmail[]
  @@index([customerId])
  @@map("service_insights")
}
 
model CallLog {
  id               Int        @id @default(autoincrement())
  customerId       Int        @map("customer_id")
  telecallerId     Int        @map("telecaller_id")
  callSid          String?    @unique @map("call_sid")
  recordingSid     String?    @map("recording_sid")
  recordingUrl     String?    @map("recording_url")
  callDate         DateTime   @default(now()) @map("call_date")
  callStatus       String     @map("call_status")
  callDuration     Int?       @map("call_duration")
  notes            String?
  followUpRequired Boolean    @default(false) @map("follow_up_required")
  followUpDate     DateTime?  @map("follow_up_date") @db.Date
  serviceBooked    Boolean    @default(false) @map("service_booked")
  bookingDate      DateTime?  @map("booking_date") @db.Date
  transcript       String?
  sentimentAnalysis String?    @map("sentiment_analysis")
  sentimentScore   Float?     @map("sentiment_score")
  customer         Customer   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  telecaller       Telecaller @relation(fields: [telecallerId], references: [id])
 
  @@index([customerId])
  @@index([telecallerId])
  @@map("call_logs")
}
 
model SurveyResponse {
  id                    Int       @id @default(autoincrement())
  customerId            Int?      @map("customer_id")
  preferredLanguage     String    @map("preferred_language")
  visitReasons          Json      @map("visit_reasons")
  rating                Int
  comments              String?
  firstTimeCompletion   Boolean   @map("first_time_completion")
  returnReasons         Json?     @map("return_reasons")
  contactAgreement      Boolean   @map("contact_agreement")
  customerName          String?   @map("customer_name")
  customerEmail         String?   @map("customer_email")
  customerPhone         String?   @map("customer_phone")
  vehicleNumber         String?   @map("vehicle_number")
  waitTimeRating        Int?      @map("wait_time_rating")
  communicationRating   Int?      @map("communication_rating")
  npsScore              Int?      @map("nps_score")
  sentimentScore        Float?    @map("sentiment_score")
  emotionAnalysis       Json?     @map("emotion_analysis")
  submittedAt           DateTime  @default(now()) @map("submitted_at")
  ipAddress             String?   @map("ip_address")
  customer              Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
 
  @@index([customerId])
  @@index([submittedAt])
  @@index([rating])
  @@index([npsScore])
  @@map("survey_responses")
}
 
model WhatsappMessage {
  id          Int       @id @default(autoincrement())
  customerId  Int       @map("customer_id")
  insightId   Int?      @map("insight_id")
  messageSid  String    @unique @map("message_sid")
  messageBody String?   @map("message_body")
  status      String    @default("sent") // sent, delivered, read, failed
  sentAt      DateTime  @default(now()) @map("sent_at")
  readAt      DateTime? @map("read_at")
 
  customer Customer        @relation(fields: [customerId], references: [id])
  insight  ServiceInsight? @relation(fields: [insightId], references: [id])
  telecaller Telecaller?   @relation(fields: [telecallerId], references: [id]) // Optional because system might send auto-messages in future, but for now it's from telecaller
  telecallerId Int?        @map("telecaller_id")
 
  @@index([customerId])
  @@index([status])
  @@map("whatsapp_messages")
}
 
model SmsMessage {
  id          Int       @id @default(autoincrement())
  customerId  Int       @map("customer_id")
  insightId   Int?      @map("insight_id")
  messageSid  String    @unique @map("message_sid")
  messageBody String?   @map("message_body")
  status      String    @default("sent") // sent, delivered, failed
  sentAt      DateTime  @default(now()) @map("sent_at")
 
  customer   Customer        @relation(fields: [customerId], references: [id])
  insight    ServiceInsight? @relation(fields: [insightId], references: [id])
  telecaller Telecaller?     @relation(fields: [telecallerId], references: [id])
  telecallerId Int?          @map("telecaller_id")
 
  @@index([customerId])
  @@index([status])
  @@map("sms_messages")
}
 
model ServiceEmail {
  id        Int            @id @default(autoincrement())
  insightId Int            @map("insight_id")
  customerId Int           @map("customer_id")
  sentAt    Float          @map("sent_at")
  seenAt    Float?         @map("seen_at")
  sentBy    Int            @map("sent_by")
  emailBody String?        @map("email_body")
  insight   ServiceInsight @relation(fields: [insightId], references: [id], onDelete: Cascade)
  customer  Customer       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  sender    Telecaller     @relation(fields: [sentBy], references: [id])
  @@map("service_emails")
}

model SourceMetric {
  id         Int      @id @default(autoincrement())
  customerId Int      @map("customer_id")
  source     String   // 'email' or 'sms'
  firstOpenedAt DateTime @default(now()) @map("first_opened_at")
  lastOpenedAt  DateTime @updatedAt @map("last_opened_at")
  openCount  Int      @default(1) @map("open_count")
  
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  @@unique([customerId, source])
  @@index([source])
  @@index([customerId])
  @@map("source_metrics")
}

model ServiceCenter {
  id          Int      @id @default(autoincrement())
  name        String
  address     String
  email       String
  phoneNo     String   @map("phone_no")
  website     String
  mapsLink    String   @map("maps_link")
  
  appointments ServiceAppointment[]
  callbackRequests CallbackRequest[]
  preferredByCustomers Customer[] @relation("PreferredServiceCenter")

  @@map("service_centers")
}

model ServiceAppointment {
  id            Int      @id @default(autoincrement())
  customerId    Int      @map("customer_id")
  serviceCenterId Int    @map("service_center")
  createdAt     DateTime @default(now()) @map("created_at")
  slot          DateTime
  isPreferred   Boolean? @map("is_preferred")
  reason        String?
  serviceType   String?  @map("service_type")
  odometer      Int?
  status        String?
  isCancelled   Boolean  @default(false) @map("is_cancelled")

  customer      Customer      @relation(fields: [customerId], references: [id])
  serviceCenter ServiceCenter @relation(fields: [serviceCenterId], references: [id])

  @@map("service_appointments")
}

model CallbackRequest {
  id              Int       @id @default(autoincrement())
  customerId      Int?      @map("customer_id")
  serviceCenterId Int?      @map("service_center")
  requestedAt     DateTime? @default(now()) @map("requested_at")
  status          String?
  updatedAt       DateTime? @updatedAt @map("updated_at")

  customer        Customer?      @relation(fields: [customerId], references: [id])
  serviceCenter   ServiceCenter? @relation(fields: [serviceCenterId], references: [id])

  @@map("callback_requests")
}